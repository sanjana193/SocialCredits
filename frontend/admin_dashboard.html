<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">Admin Dashboard</a>
    <div class="collapse navbar-collapse">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link" href="#leaderboard">🏆 Leaderboard</a></li>
        <li class="nav-item"><a class="nav-link" href="#users">👥 Users</a></li>
        <li class="nav-item"><a class="nav-link" href="#logs">📝 Help Logs</a></li>
        <li class="nav-item"><a class="nav-link" href="#requests">📄 Requests</a></li>
        <li class="nav-item"><a class="nav-link" href="#charts">📊 Charts</a></li>

    </ul>
    </div>
  </div>
</nav>

<div class="container mt-4">

  <!-- Leaderboard -->
  <section id="leaderboard">
    <h2>🏆 Leaderboard</h2>
    <div class="row mb-4" id="leaderboardCards"></div>
  </section>

  <!-- Charts -->
<section id="charts">
  <h2>📊 Insights & Charts</h2>
  <div class="row">
    <div class="col-md-6 mb-4">
      <canvas id="creditsChart"></canvas>
    </div>
    <div class="col-md-6 mb-4">
      <canvas id="tasksChart"></canvas>
    </div>
  </div>
</section>

  <!-- Users -->
  <section id="users">
    <h2>👥 All Users</h2>
    <input class="form-control mb-3" id="searchInput" placeholder="Search users/logs/requests..." oninput="filterTables()">
    <button class="btn btn-sm btn-outline-primary mb-2" onclick="downloadCSV('usersTable', 'users.csv')">Download</button>
    <div class="table-responsive">
      <table class="table table-bordered" id="usersTable">
        <thead><tr><th>Name</th><th>Email</th><th>Credits</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- Logs -->
  <section id="logs">
    <h2>📝 All Help Logs</h2>
    <button class="btn btn-sm btn-outline-primary mb-2" onclick="downloadCSV('logsTable', 'help_logs.csv')">Download</button>
    <div class="table-responsive">
      <table class="table table-bordered" id="logsTable">
        <thead><tr><th>From</th><th>To</th><th>Task</th><th>Hours</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- Requests -->
  <section id="requests">
    <h2>📄 All Help Requests</h2>
    <button class="btn btn-sm btn-outline-primary mb-2" onclick="downloadCSV('requestsTable', 'requests.csv')">Download</button>
    <div class="table-responsive">
      <table class="table table-bordered" id="requestsTable">
        <thead><tr><th>User</th><th>Task</th><th>Credits</th><th>Status</th><th>Fulfiller</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

</div>

<script>
const apiBase = `http://localhost:3000/api/admin`;

document.addEventListener('DOMContentLoaded', loadDashboard);

async function loadDashboard() {
  const users = await fetch(`${apiBase}/users`).then(r => r.json());
  const logs = await fetch(`${apiBase}/logs`).then(r => r.json());
  const requests = await fetch(`${apiBase}/requests`).then(r => r.json());

  populateUsers(users);
  populateLogs(logs);
  populateRequests(requests);
  populateLeaderboard(users);
}

function populateUsers(users) {
  const tbody = document.querySelector('#usersTable tbody');
  tbody.innerHTML = '';
  users.forEach(u => {
    const row = tbody.insertRow();
    row.innerHTML = `<td>${u.name}</td><td>${u.email}</td><td>${u.credits}</td>`;
  });
}

function populateLogs(logs) {
  const tbody = document.querySelector('#logsTable tbody');
  tbody.innerHTML = '';
  logs.forEach(l => {
    const row = tbody.insertRow();
    row.innerHTML = `<td>${l.from_user.name}</td><td>${l.to_user.name}</td><td>${l.task}</td><td>${l.hours}</td>`;
  });
}

function populateRequests(reqs) {
  const tbody = document.querySelector('#requestsTable tbody');
  tbody.innerHTML = '';
  reqs.forEach(r => {
    const row = tbody.insertRow();
    const fulfiller = r.fulfilled_by?.name || 'N/A';
    row.innerHTML = `<td>${r.by_user.name}</td><td>${r.task}</td><td>${r.credits_used}</td><td>${r.status}</td><td>${fulfiller}</td>`;
  });
}

function populateLeaderboard(users) {
  const sorted = [...users].sort((a, b) => b.credits - a.credits).slice(0, 3);
  const board = document.getElementById('leaderboardCards');
  board.innerHTML = '';
  sorted.forEach((u, i) => {
    board.innerHTML += `
      <div class="col-md-4">
        <div class="card text-white bg-success mb-3">
          <div class="card-header">#${i + 1}</div>
          <div class="card-body">
            <h5 class="card-title">${u.name}</h5>
            <p class="card-text">${u.credits} Credits</p>
          </div>
        </div>
      </div>`;
  });
}
async function loadDashboard() {
  const users = await fetch(`${apiBase}/users`).then(r => r.json());
  const logs = await fetch(`${apiBase}/logs`).then(r => r.json());
  const requests = await fetch(`${apiBase}/requests`).then(r => r.json());

  populateUsers(users);
  populateLogs(logs);
  populateRequests(requests);
  populateLeaderboard(users);
  renderCharts(users, logs);
}

function renderCharts(users, logs) {
  // 👥 Calculate total hours spent helping others by user
  const userHoursMap = {};
  logs.forEach(l => {
    if (!userHoursMap[l.from_user._id]) {
      userHoursMap[l.from_user._id] = { name: l.from_user.name, hours: 0 };
    }
    userHoursMap[l.from_user._id].hours += l.hours || 0;
  });

  const sortedUsers = Object.values(userHoursMap).sort((a, b) => b.hours - a.hours).slice(0, 5);

  const creditsCtx = document.getElementById('creditsChart').getContext('2d');
  new Chart(creditsCtx, {
    type: 'bar',
    data: {
      labels: sortedUsers.map(u => u.name),
      datasets: [{
        label: 'Hours Spent Helping Others',
        data: sortedUsers.map(u => u.hours),
        backgroundColor: 'rgba(75, 192, 192, 0.7)'
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false },
        title: { display: true, text: 'Top 5 Users by Hours Spent Helping' }
      }
    }
  });

  // 📊 Task distribution from logs
  const taskCounts = {};
  logs.forEach(l => {
    taskCounts[l.task] = (taskCounts[l.task] || 0) + 1;
  });

  const tasksCtx = document.getElementById('tasksChart').getContext('2d');
  new Chart(tasksCtx, {
    type: 'doughnut',
    data: {
      labels: Object.keys(taskCounts),
      datasets: [{
        label: 'Tasks',
        data: Object.values(taskCounts),
        backgroundColor: [
          'rgba(255,99,132,0.7)',
          'rgba(54,162,235,0.7)',
          'rgba(255,206,86,0.7)',
          'rgba(75,192,192,0.7)',
          'rgba(153,102,255,0.7)',
        ]
      }]
    },
    options: {
      responsive: true,
      plugins: {
        title: { display: true, text: 'Help Tasks Distribution' }
      }
    }
  });
}



function downloadCSV(tableId, filename) {
  const rows = Array.from(document.querySelectorAll(`#${tableId} tr`));
  const csv = rows.map(r => 
      Array.from(r.cells).map(c => `"${c.innerText}"`).join(',')
  ).join('\n');

  const blob = new Blob([csv], { type: 'text/csv' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
}

function filterTables() {
  const q = document.getElementById('searchInput').value.toLowerCase();
  document.querySelectorAll('table tbody tr').forEach(row => {
    row.style.display = [...row.cells].some(c => c.innerText.toLowerCase().includes(q)) ? '' : 'none';
  });
}
</script>

</body>
</html>
