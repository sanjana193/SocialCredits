<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ðŸŽ“ Faculty Dashboard</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="p-4">
<div class="container">
  <h1>ðŸŽ“ Faculty Dashboard</h1>

  <h3>ðŸ“‹ Notices</h3>
  <div class="table-responsive mb-4">
    <table class="table table-bordered" id="noticesTable">
      <thead>
        <tr>
          <th>Title</th><th>Content</th><th>Target</th><th>Department</th><th>Year</th><th>Valid Till</th>
        </tr>
      </thead>
      <tbody><tr><td colspan="6">Loading noticesâ€¦</td></tr></tbody>
    </table>
  </div>

  <h3>Students in Your Department</h3>
  <div id="studentsList">Loading studentsâ€¦</div>

  <hr>

  <h3>ðŸ“„ Submitted Assignments</h3>
  <ul id="submittedAssignments">Loading submitted assignmentsâ€¦</ul>
</div>

<script>
const api = `http://localhost:3000/api`;
const urlParams = new URLSearchParams(window.location.search);
const facultyId = urlParams.get('userId');  

if (!facultyId) alert("Faculty ID missing in URL");

let facultyDepartment = 'CSE'; // Fetch dynamically if needed

// ðŸ”· Fetch & render notices
const params = new URLSearchParams({
  role: 'faculty',
  department: facultyDepartment
});
fetch(`${api}/notices?${params}`)
  .then(res => res.json())
  .then(notices => {
    const tbody = document.querySelector('#noticesTable tbody');
    tbody.innerHTML = '';
    if (!notices.length) {
      tbody.innerHTML = `<tr><td colspan="6">No notices available for you.</td></tr>`;
      return;
    }
    notices.forEach(n => {
      const row = tbody.insertRow();
      row.innerHTML = `
        <td>${n.title}</td>
        <td>${n.content}</td>
        <td>${n.targetAudience}</td>
        <td>${n.department || '-'}</td>
        <td>${n.year || '-'}</td>
        <td>${new Date(n.validTill).toLocaleDateString()}</td>
      `;
    });
  });

// ðŸ”· Fetch students
fetch(`${api}/faculty/students?department=${facultyDepartment}`)
  .then(res => res.json())
  .then(students => {
    const container = document.getElementById('studentsList');
    container.innerHTML = '';
    students.forEach(s => {
      const div = document.createElement('div');
      div.className = 'card p-2 mb-2';
      div.innerHTML = `
        <strong>${s.name}</strong> (${s.email})
        <button class="btn btn-sm btn-primary ms-2" onclick="markAttendance('${s._id}')">Mark Attendance</button>
        <button class="btn btn-sm btn-success ms-2" onclick="assignTask('${s._id}')">Assign Task</button>
      `;
      container.appendChild(div);
    });
  });

// ðŸ”· Fetch submitted assignments
fetch(`${api}/faculty/assignment/submitted/${facultyId}`)
  .then(res => res.json())
  .then(assignments => {
    const ul = document.getElementById('submittedAssignments');
    ul.innerHTML = '';
    if (!assignments.length) {
      ul.textContent = 'No submitted assignments yet.';
    } else {
      assignments.forEach(a => {
        const li = document.createElement('li');
        li.textContent = `${a.student.name} submitted: ${a.task}`;
        ul.appendChild(li);
      });
    }
  });

function markAttendance(studentId) {
  const subject = prompt("Enter subject:");
  const status = prompt("Enter status (present/absent):");
  if (!subject || !status) return;

  fetch(`${api}/faculty/attendance/mark`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      student: studentId,
      faculty: facultyId,
      subject,
      status,
      date: new Date()
    })
  }).then(() => alert('Attendance marked!'));
}

function assignTask(studentId) {
  const task = prompt("Enter task:");
  if (!task) return;

  fetch(`${api}/faculty/assignment/create`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      student: studentId,
      faculty: facultyId,
      task
    })
  }).then(() => alert('Assignment assigned!'));
}
</script>
</body>
</html>
